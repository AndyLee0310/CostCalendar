<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>æ”¯å‡ºçµ±è¨ˆè¡Œäº‹æ›†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">æ”¯å‡ºçµ±è¨ˆè¡Œäº‹æ›†</h2>
        <div>
            <!-- é–‹å•Ÿæœˆæ›† -->
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#calendarModal">
                ğŸ“… é–‹å•Ÿæœˆæ›†
            </button>
            
            <!-- å›åˆ°æœ¬æœˆ -->
            <button type="button" class="btn btn-primary" id="goToToday">
                ğŸ”„ å›åˆ°æœ¬æœˆ
            </button>
        </div>
    </div>
    
    <!-- æœˆæ›†å½ˆçª— -->
    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:90%; margin:2rem auto;">
            <div class="modal-content" style="height:calc(100vh - 4rem);">
                <div class="modal-header">
                    <h5 class="modal-title">{{ current_date.strftime('%Y-%m') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 overflow-hidden">
                    <iframe id="calendarIframe" src="/calendar" frameborder="0"
                        style="width:100%; height:100%; overflow:hidden;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ‡æ›æœˆä»½æŒ‰éˆ• -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a class="btn btn-outline-primary" href="/?month={{ prev_month }}">âŸµ ä¸Šå€‹æœˆ</a>
        <h3>{{ current_date.strftime('%Y å¹´ %m æœˆ') }}</h3>
        <a class="btn btn-outline-primary" href="/?month={{ next_month }}">ä¸‹å€‹æœˆ âŸ¶</a>
    </div>


    <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
    <form method="post" class="mb-5">
        <div class="row g-2">
            <div class="col-md-4">
                <input class="form-control" type="text" name="item" placeholder="æ”¯å‡ºé …ç›®" required>
            </div>
            <div class="col-md-3">
                <input class="form-control" type="number" name="amount" placeholder="é‡‘é¡" required>
            </div>
            <div class="col-md-3">
                <input class="form-control" type="date" name="date" required>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" type="submit">æ–°å¢</button>
            </div>
        </div>
    </form>

    <!-- æ¯æ—¥æ”¯å‡ºæ˜ç´° -->
    <h4>æœ¬æœˆæ”¯å‡ºæ˜ç´°</h4>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th class="text-center">#</th>
                <th>æ—¥æœŸ</th>
                <th>é …ç›®</th>
                <th>é‡‘é¡</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses %}
            <tr>
                <td class="text-center">{{ loop.index }}</td>
                <td>{{ exp.date.strftime('%Y-%m-%d') }}</td>
                <td>{{ exp.item }}</td>
                <td>{{ "{:,}".format(exp.amount) }}</td>
                <td>
                    <form method="post" action="{{ url_for('delete', id=exp.id) }}"
                        onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')">
                        <button type="submit" class="btn btn-sm btn-danger">åˆªé™¤</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- æ¯é€±æ”¯å‡ºçµ±è¨ˆ -->
    <h4 class="mt-5">æ¯é€±æ”¯å‡ºçµ±è¨ˆ</h4>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ç¬¬å¹¾é€±</th>
                <th>ç¸½æ”¯å‡º</th>
            </tr>
        </thead>
        <tbody>
            {% for week in weekly_expenses %}
            <tr>
                <td>ç¬¬ {{ loop.index }} é€±</td>
                <td>{{ "{:,}".format(week.total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- æœˆæ”¯å‡ºç¸½è¨ˆ -->
    <h4 class="mt-5">æœ¬æœˆç¸½æ”¯å‡ºï¼š <span class="text-danger">{{ "{:,}".format(month_total) }}</span> å…ƒ</h4>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var todayButton = document.getElementById('goToToday');
            var calendarModal = document.getElementById('calendarModal');
        
            // ç•¶é»æ“Šã€Œå›åˆ°æœ¬æœˆã€æŒ‰éˆ•
            todayButton.addEventListener('click', function () {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0'); // æœˆä»½å¾ 0 é–‹å§‹ï¼Œæ‰€ä»¥è¦ +1
        
                // é‡æ–°å°å‘åˆ°æœ¬æœˆ
                window.location.href = `/?month=${year}-${month}`;
            });
        
            // ç•¶é–‹å•Ÿæœˆæ›†æ™‚ï¼Œç¢ºä¿ iframe ä¹Ÿè¼‰å…¥æ­£ç¢ºçš„æœˆä»½
            calendarModal.addEventListener('show.bs.modal', function () {
                const params = new URLSearchParams(window.location.search);
                const month = params.get('month') || new Date().toISOString().slice(0, 7); // å–å¾—ç•¶å‰æœˆä»½
                document.getElementById('calendarIframe').src = `/calendar?month=${month}`;
            });
        });
        </script>
        


    <!-- Bootstrap JS bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>